<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatWar Downloader</title>
    <style>
        /* –°–¢–ò–õ–ò –û–°–¢–ê–Æ–¢–°–Ø –ü–†–ï–ñ–ù–ò–ú–ò - –æ–Ω–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* ... –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */
        
    </style>
</head>
<body>
    <div class="container">
        <!-- HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
        
        <div class="content">
            <!-- ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ... -->
        </div>
    </div>

    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
        const CORS_PROXIES = [
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://cors-anywhere.herokuapp.com/'
        ];

        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let allUrls = [];
        let validUrls = [];
        let downloadQueue = [];
        let isChecking = false;
        let isDownloading = false;
        let currentIndex = 0;
        let totalFiles = 0;
        let currentProxyIndex = 0;
        let checkedCount = 0;
        let validCount = 0;
        let invalidCount = 0;
        let downloadedCount = 0;
        let abortController = null;
        let currentFolderName = "CatWar_Downloads";
        let useStrictVerification = true;

        // ==================== –°–õ–£–ñ–ï–ë–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'generator') {
                const type = document.getElementById('contentType').value;
                document.getElementById('costumeVersionsContainer').style.display = 
                    type === 'costume' ? 'block' : 'none';
            }
        }

        // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–†–û–ö–°–ò
        function getProxyUrl(url) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL
            const separator = CORS_PROXIES[currentProxyIndex].includes('?') ? '&' : '?';
            return CORS_PROXIES[currentProxyIndex] + encodeURIComponent(url);
        }

        function rotateProxy() {
            currentProxyIndex = (currentProxyIndex + 1) % CORS_PROXIES.length;
            const proxyNames = ['corsproxy.io', 'codetabs.com', 'cors-anywhere'];
            document.getElementById('currentProxy').textContent = proxyNames[currentProxyIndex];
            addLog(`üîÑ –°–º–µ–Ω–∞ –ø—Ä–æ–∫—Å–∏ –Ω–∞: ${proxyNames[currentProxyIndex]}`, 'proxy');
        }

        function updateStats() {
            document.getElementById('checkedCount').textContent = checkedCount;
            document.getElementById('validCount').textContent = validCount;
            document.getElementById('invalidCount').textContent = invalidCount;
            document.getElementById('downloadedCount').textContent = downloadedCount;
        }

        function setPhase(phase) {
            document.getElementById('phaseCheck').classList.remove('active');
            document.getElementById('phaseDownload').classList.remove('active');
            
            if (phase === 'check') {
                document.getElementById('phaseCheck').classList.add('active');
                document.getElementById('currentPhase').textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤';
            } else {
                document.getElementById('phaseDownload').classList.add('active');
                document.getElementById('currentPhase').textContent = '–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤';
            }
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ==================== –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô ====================
        async function checkImageExists(url) {
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    const proxyUrl = getProxyUrl(url);
                    
                    // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ó–ê–ü–†–û–°: –¥–æ–±–∞–≤–ª—è–µ–º timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);
                    
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        signal: controller.signal,
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                            'Accept': 'image/*, */*'
                        }
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        if (response.status === 404) {
                            return { exists: false, error: '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω (404)' };
                        } else if (response.status === 403) {
                            throw new Error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω (403)');
                        } else if (response.status >= 500) {
                            throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                        } else {
                            throw new Error(`HTTP ${response.status}`);
                        }
                    }

                    // üîß –£–ü–†–û–©–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê - —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
                    const blob = await response.blob();
                    
                    if (blob.size < 100) {
                        return { exists: false, error: '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π' };
                    }

                    return { 
                        exists: true, 
                        size: blob.size,
                        type: response.headers.get('content-type') || 'unknown'
                    };

                } catch (error) {
                    if (error.name === 'AbortError') {
                        addLog(`‚è∞ –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ–ø—ã—Ç–∫–∞ ${attempt})`, 'warning');
                    } else {
                        addLog(`‚ùå –û—à–∏–±–∫–∞ (–ø–æ–ø—ã—Ç–∫–∞ ${attempt}): ${error.message}`, 'error');
                    }
                    
                    if (attempt < 3) {
                        rotateProxy();
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } else {
                        return { exists: false, error: error.message };
                    }
                }
            }
            return { exists: false, error: '–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å' };
        }

        // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ü–ê–ü–ö–ê–ú–ò ====================
        function getFolderName() {
            const activeTab = document.querySelector('.tab-content.active').id;
            switch(activeTab) {
                case 'bbcode': return document.getElementById('folderName').value || 'CatWar_Downloads';
                case 'generator': return document.getElementById('folderNameGenerator').value || 'CatWar_Downloads';
                case 'mass': return document.getElementById('folderNameMass').value || 'CatWar_Downloads';
                case 'quick': return document.getElementById('folderNameQuick').value || 'CatWar_Downloads';
                default: return 'CatWar_Downloads';
            }
        }

        function getContentTypeFromUrl(url) {
            if (url.includes('/costume/')) return 'costumes';
            if (url.includes('/odoroj/')) return 'odors';
            if (url.includes('/actions/')) return 'actions';
            if (url.includes('/achievement/')) return 'achievements';
            if (url.includes('/medal/')) return 'medals';
            if (url.includes('/spacoj/')) return 'backgrounds';
            if (url.includes('/things/')) return 'items';
            return 'other';
        }

        function getSubfolderName(url) {
            return getContentTypeFromUrl(url);
        }

        // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–û–ó–î–ê–ù–ò–Ø –ò–ú–ï–ù–ò –§–ê–ô–õ–ê
        function createDownloadFilename(url) {
            const filename = getFilenameFromUrl(url);
            const subfolder = getSubfolderName(url);
            const folderName = getFolderName();
            
            // –°–æ–∑–¥–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
            return `${folderName}_${subfolder}_${filename}`;
        }

        function updateFolderInfo() {
            currentFolderName = getFolderName();
            document.getElementById('currentFolder').textContent = currentFolderName;
        }

        // ==================== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –°–ö–ê–ß–ò–í–ê–ù–ò–Ø ====================
        async function processCheckQueue(urls, delay) {
            if (!isChecking || currentIndex >= urls.length) {
                if (currentIndex >= urls.length) {
                    finishCheckPhase();
                }
                return;
            }

            const url = urls[currentIndex];
            const filename = getFilenameFromUrl(url);

            const progress = ((currentIndex + 1) / totalFiles) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${currentIndex + 1}/${totalFiles}`;
            document.getElementById('statusText').textContent = `–ü—Ä–æ–≤–µ—Ä–∫–∞: ${filename}`;

            try {
                addLog(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞: ${filename}`, 'check');
                
                const result = await checkImageExists(url);
                
                checkedCount++;
                
                if (result.exists) {
                    validUrls.push(url);
                    validCount++;
                    addLog(`‚úÖ –í–∞–ª–∏–¥–Ω—ã–π: ${filename} (${formatFileSize(result.size)})`, 'success');
                } else {
                    invalidCount++;
                    addLog(`‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π: ${filename} - ${result.error}`, 'error');
                }

            } catch (error) {
                if (error.name !== 'AbortError') {
                    checkedCount++;
                    invalidCount++;
                    addLog(`üí• –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${filename} - ${error.message}`, 'error');
                }
            }

            updateStats();
            currentIndex++;

            if (currentIndex < urls.length && isChecking) {
                setTimeout(() => processCheckQueue(urls, delay), delay);
            } else {
                finishCheckPhase();
            }
        }

        function finishCheckPhase() {
            isChecking = false;
            
            if (validUrls.length > 0) {
                addLog(`üéØ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –í–∞–ª–∏–¥–Ω—ã—Ö: ${validUrls.length}/${allUrls.length}`, 'success');
                addLog(`üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ ${validUrls.length} —Ñ–∞–π–ª–æ–≤...`, 'info');
                
                setTimeout(() => startDownloadPhase(validUrls), 1000);
            } else {
                document.getElementById('statusText').textContent = '–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤';
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('skipBtn').disabled = true;
                addLog('üí• –ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', 'error');
            }
        }

        // üîß –ü–ï–†–ï–ü–ò–°–ê–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–ö–ê–ß–ò–í–ê–ù–ò–Ø
        async function downloadImage(url, filename) {
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    const proxyUrl = getProxyUrl(url);
                    const subfolder = getSubfolderName(url);
                    const downloadFilename = createDownloadFilename(url);
                    
                    addLog(`üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ: ${subfolder}/${filename} (–ø–æ–ø—ã—Ç–∫–∞ ${attempt})`, 'info');
                    
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π AbortController –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);
                    
                    const response = await fetch(proxyUrl, {
                        signal: controller.signal,
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                            'Accept': 'image/*, */*'
                        }
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const blob = await response.blob();
                    if (blob.size < 100) {
                        throw new Error('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π');
                    }

                    // üîß –£–ü–†–û–©–ï–ù–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï
                    const blobUrl = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = downloadFilename;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // –û—á–∏—Å—Ç–∫–∞
                    setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
                    
                    return { success: true, size: blob.size };

                } catch (error) {
                    if (error.name === 'AbortError') {
                        addLog(`‚èπÔ∏è –û—Ç–º–µ–Ω–µ–Ω–æ: ${filename}`, 'warning');
                        throw error;
                    }
                    
                    addLog(`‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (–ø–æ–ø—ã—Ç–∫–∞ ${attempt}): ${error.message}`, 'error');
                    
                    if (attempt < 3) {
                        rotateProxy();
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }
            return { success: false, size: 0 };
        }

        async function processDownloadQueue(urls, delay) {
            if (!isDownloading || currentIndex >= urls.length) {
                if (currentIndex >= urls.length) {
                    finishDownloadPhase();
                }
                return;
            }

            const url = urls[currentIndex];
            const filename = getFilenameFromUrl(url);
            const subfolder = getSubfolderName(url);

            const progress = ((currentIndex + 1) / urls.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${currentIndex + 1}/${urls.length}`;
            document.getElementById('statusText').textContent = `–°–∫–∞—á–∏–≤–∞–Ω–∏–µ: ${subfolder}/${filename}`;

            try {
                const result = await downloadImage(url, filename);
                
                if (result.success) {
                    downloadedCount++;
                    addLog(`‚úÖ –°–∫–∞—á–∞–Ω: ${subfolder}/${filename} (${formatFileSize(result.size)})`, 'success');
                } else {
                    addLog(`üí• –ù–µ —Å–∫–∞—á–∞–Ω: ${subfolder}/${filename}`, 'error');
                }

            } catch (error) {
                if (error.name !== 'AbortError') {
                    addLog(`üí• –û—à–∏–±–∫–∞: ${subfolder}/${filename} - ${error.message}`, 'error');
                }
            }

            updateStats();
            currentIndex++;

            if (currentIndex < urls.length && isDownloading) {
                setTimeout(() => processDownloadQueue(urls, delay), delay);
            } else {
                finishDownloadPhase();
            }
        }

        function startDownloadPhase(urls) {
            setPhase('download');
            
            downloadQueue = urls;
            currentIndex = 0;
            isDownloading = true;

            document.getElementById('progressText').textContent = `0/${urls.length}`;
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('statusText').textContent = '–ù–∞—á–∞–ª–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è...';

            const delay = getCurrentDelay();
            processDownloadQueue(urls, delay);
        }

        function finishDownloadPhase() {
            isDownloading = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('skipBtn').disabled = true;
            
            const successRate = validUrls.length > 0 ? Math.round((downloadedCount / validUrls.length) * 100) : 0;
            
            document.getElementById('statusText').textContent = 
                `–ó–∞–≤–µ—Ä—à–µ–Ω–æ! –°–∫–∞—á–∞–Ω–æ: ${downloadedCount}/${validUrls.length} (${successRate}%)`;
            addLog(`üéâ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã!`, 'success');
            addLog(`üìä –ò—Ç–æ–≥: –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ ${checkedCount}, –í–∞–ª–∏–¥–Ω—ã—Ö ${validCount}, –°–∫–∞—á–∞–Ω–æ ${downloadedCount}`, 'info');
        }

        function stopDownload() {
            isChecking = false;
            isDownloading = false;
            if (abortController) {
                abortController.abort();
            }
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('skipBtn').disabled = true;
            document.getElementById('statusText').textContent = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
            addLog('‚èπÔ∏è –ü—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'warning');
        }

        function skipCurrent() {
            if (isChecking || isDownloading) {
                currentIndex++;
                addLog('‚è≠Ô∏è –¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª –ø—Ä–æ–ø—É—â–µ–Ω', 'warning');
                updateStats();
            }
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–û–¶–ï–°–°–ê ====================
        function startCheckPhase(urls, delay) {
            // üîß –°–ë–†–û–° –í–°–ï–• –ü–ï–†–ï–ú–ï–ù–ù–´–•
            allUrls = urls;
            validUrls = [];
            checkedCount = 0;
            validCount = 0;
            invalidCount = 0;
            downloadedCount = 0;
            currentIndex = 0;
            totalFiles = urls.length;
            currentProxyIndex = 0;
            isChecking = true;
            isDownloading = false;

            updateFolderInfo();

            // üîß –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressText').textContent = `0/${totalFiles}`;
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('statusText').textContent = '–ù–∞—á–∞–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏...';
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('skipBtn').disabled = false;
            
            // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
            document.getElementById('logContainer').innerHTML = '';

            setPhase('check');
            updateStats();
            
            addLog(`üîç –ù–∞—á–∞–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${totalFiles} —Ñ–∞–π–ª–æ–≤`, 'info');
            addLog(`üåê –ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–∫—Å–∏: corsproxy.io`, 'proxy');
            addLog(`‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞: ${delay}–º—Å`, 'info');

            processCheckQueue(urls, delay);
        }

        function getCurrentDelay() {
            const activeTab = document.querySelector('.tab-content.active').id;
            switch(activeTab) {
                case 'bbcode': return parseInt(document.getElementById('delay1').value) || 800;
                case 'generator': return parseInt(document.getElementById('delayGenerator').value) || 800;
                case 'mass': return parseInt(document.getElementById('massDelay').value) || 600;
                case 'quick': return parseInt(document.getElementById('delayQuick').value) || 500;
                default: return 800;
            }
        }

        // ==================== –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ====================
        function parseAndDownloadBBCode() {
            const bbcodeText = document.getElementById('bbcodeInput').value;
            const delay = parseInt(document.getElementById('delay1').value) || 800;
            const limit = parseInt(document.getElementById('limit1').value) || 20;

            const urls = [];
            const imgRegex = /\[img\](.*?)\[\/img\]/g;
            let match;

            while ((match = imgRegex.exec(bbcodeText)) !== null && urls.length < limit) {
                const url = match[1].trim();
                if (url.startsWith('http')) {
                    urls.push(url);
                }
            }

            if (urls.length === 0) {
                alert('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∞–ª–∏–¥–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –≤ BB-–∫–æ–¥–∞—Ö');
                return;
            }

            startCheckPhase(urls, delay);
        }

        function generateAndDownload() {
            const type = document.getElementById('contentType').value;
            const startId = parseInt(document.getElementById('startId').value) || 1;
            const endId = parseInt(document.getElementById('endId').value) || 20;
            const additionalIds = document.getElementById('additionalIds').value
                .split(',')
                .map(id => parseInt(id.trim()))
                .filter(id => !isNaN(id));
            const delay = parseInt(document.getElementById('delayGenerator').value) || 800;
            const limit = parseInt(document.getElementById('limitGenerator').value) || 30;

            const urls = [];
            const baseUrls = {
                costume: 'https://catwar.net/cw3/cats/{X}/costume/',
                odoroj: 'https://catwar.net/cw3/odoroj/',
                actions: 'https://catwar.net/cw3/actions/',
                achievement: 'https://catwar.net/cw3/achievement/',
                medal: 'https://catwar.net/cw3/medal/',
                spacoj: 'https://catwar.net/cw3/spacoj/',
                things: 'https://catwar.net/cw3/things/'
            };

            // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ì–ï–ù–ï–†–ê–¶–ò–Ø URL
            if (type === 'costume') {
                const versions = Array.from(document.querySelectorAll('input[name="version"]:checked'))
                    .map(input => input.value);
                
                if (versions.length === 0) {
                    alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≤–µ—Ä—Å–∏—é –∫–æ—Å—Ç—é–º–∞');
                    return;
                }
                
                versions.forEach(version => {
                    for (let id = startId; id <= endId && urls.length < limit; id++) {
                        urls.push(`${baseUrls.costume.replace('{X}', version)}${id}.png`);
                    }
                });
            } else {
                const baseUrl = baseUrls[type];
                for (let id = startId; id <= endId && urls.length < limit; id++) {
                    urls.push(`${baseUrl}${id}.png`);
                }
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ ID
            additionalIds.forEach(id => {
                if (urls.length < limit) {
                    if (type === 'costume') {
                        const versions = Array.from(document.querySelectorAll('input[name="version"]:checked'))
                            .map(input => input.value);
                        versions.forEach(version => {
                            if (urls.length < limit) {
                                urls.push(`${baseUrls.costume.replace('{X}', version)}${id}.png`);
                            }
                        });
                    } else {
                        urls.push(`${baseUrls[type]}${id}.png`);
                    }
                }
            });

            const uniqueUrls = [...new Set(urls)].slice(0, limit);
            
            if (uniqueUrls.length === 0) {
                alert('‚ùå –ù–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ URL');
                return;
            }

            startCheckPhase(uniqueUrls, delay);
        }

        function downloadMassUrls() {
            const urlsText = document.getElementById('massUrls').value;
            const delay = parseInt(document.getElementById('massDelay').value) || 600;
            const limit = parseInt(document.getElementById('massLimit').value) || 25;

            const urls = urlsText.split('\n')
                .map(url => url.trim())
                .filter(url => url && url.startsWith('http'))
                .slice(0, limit);

            if (urls.length === 0) {
                alert('‚ùå –ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏');
                return;
            }

            startCheckPhase(urls, delay);
        }

        function loadPreset(presetName) {
            const presets = {
                costumes: `https://catwar.net/cw3/cats/0/costume/1.png\nhttps://catwar.net/cw3/cats/0/costume/2.png\nhttps://catwar.net/cw3/cats/0/costume/3.png`,
                odors: `https://catwar.net/cw3/odoroj/1.png\nhttps://catwar.net/cw3/odoroj/2.png\nhttps://catwar.net/cw3/odoroj/3.png\nhttps://catwar.net/cw3/odoroj/4.png`,
                actions: `https://catwar.net/cw3/actions/1.png\nhttps://catwar.net/cw3/actions/2.png\nhttps://catwar.net/cw3/actions/3.png`,
                achievements: `https://catwar.net/cw3/achievement/1.png\nhttps://catwar.net/cw3/achievement/2.png\nhttps://catwar.net/cw3/achievement/3.png`
            };
            
            document.getElementById('massUrls').value = presets[presetName] || '';
            addLog(`üìÅ –ó–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–µ—Å–µ—Ç: ${presetName}`, 'info');
        }

        function quickDownload(type) {
            const presets = {
                costumes: Array.from({length: 6}, (_, i) => `https://catwar.net/cw3/cats/0/costume/${i + 1}.png`),
                odors: Array.from({length: 6}, (_, i) => `https://catwar.net/cw3/odoroj/${i + 1}.png`),
                medals: Array.from({length: 6}, (_, i) => `https://catwar.net/cw3/medal/${i + 1}.png`),
                items: Array.from({length: 6}, (_, i) => `https://catwar.net/cw3/things/${i + 1}.png`),
                actions: Array.from({length: 6}, (_, i) => `https://catwar.net/cw3/actions/${i + 1}.png`),
                achievements: Array.from({length: 6}, (_, i) => `https://catwar.net/cw3/achievement/${i + 1}.png`),
                backgrounds: Array.from({length: 6}, (_, i) => `https://catwar.net/cw3/spacoj/${i + 1}.png`)
            };
            
            const urls = presets[type] || [];
            const delay = parseInt(document.getElementById('delayQuick').value) || 500;
            
            if (urls.length === 0) {
                alert('‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏');
                return;
            }
            
            startCheckPhase(urls, delay);
        }

        function testQuickDownload() {
            const testUrls = [
                'https://catwar.net/cw3/cats/0/costume/1.png',
                'https://catwar.net/cw3/cats/0/costume/2.png',
                'https://catwar.net/cw3/cats/0/costume/3.png',
                'https://catwar.net/cw3/odoroj/1.png',
                'https://catwar.net/cw3/odoroj/2.png',
                'https://catwar.net/cw3/actions/1.png'
            ];
            const delay = parseInt(document.getElementById('delayQuick').value) || 500;
            startCheckPhase(testUrls, delay);
        }

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function getFilenameFromUrl(url) {
            const matches = url.match(/\/([^\/]+\.(png|jpg|jpeg|gif))$/i);
            return matches ? matches[1] : `file_${Date.now()}.png`;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        document.addEventListener('DOMContentLoaded', function() {
            // –û—á–∏—â–∞–µ–º –ª–æ–≥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            document.getElementById('logContainer').innerHTML = '';
            
            addLog('üîß CatWar Downloader v2.1 –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'info');
            addLog('üåê –î–æ—Å—Ç—É–ø–Ω–æ 3 CORS –ø—Ä–æ–∫—Å–∏', 'proxy');
            addLog('üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç" –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'info');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
            document.getElementById('contentType').addEventListener('change', function() {
                document.getElementById('costumeVersionsContainer').style.display = 
                    this.value === 'costume' ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>
